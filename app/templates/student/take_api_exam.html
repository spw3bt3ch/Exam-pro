{% extends "base.html" %}

{% block title %}{{ subject.name }} - API Exam{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header with timer and progress -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ subject.name }}</h1>
                <p class="text-gray-600 dark:text-gray-300">{{ subject.description }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    ‚è±Ô∏è {{ subject.duration_minutes }} minutes | üìù {{ questions|length }} questions
                </p>
            </div>
            <div class="text-right">
                <div id="timer" class="text-2xl font-mono font-bold text-red-600 dark:text-red-400">
                    {{ (subject.duration_minutes * 60) // 60 }}:{{ "%02d" % ((subject.duration_minutes * 60) % 60) }}
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Time Remaining</p>
            </div>
        </div>
        
        <!-- Progress bar -->
        <div class="mb-4">
            <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-400 mb-2">
                <span>Question <span id="current-question">1</span> of {{ questions|length }}</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                <div id="progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
            <div class="flex items-center">
                <svg class="h-5 w-5 text-green-600 dark:text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <h3 class="text-sm font-medium text-green-800 dark:text-green-200">Exam Instructions</h3>
                    <p class="text-sm text-green-700 dark:text-green-300 mt-1">
                        Answer each question and use Next/Previous to navigate. Submit when you're done with all questions.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Question container -->
    <form id="exam-form" method="post" action="{{ url_for('student.submit_api_exam', subject_id=subject.id) }}">
        {# Embed the original API questions payload so the server grades the same questions #}
        <input type="hidden" name="questions_payload_json" id="questions_payload_json" value='{{ questions_payload | tojson | safe }}'>
        <div id="questions-container">
            {% for question in questions %}
            <div class="question-slide bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6" 
                 data-question="{{ loop.index }}" style="display: {% if loop.index == 1 %}block{% else %}none{% endif %};">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                        Question {{ loop.index }}
                    </h3>
                    <p class="text-gray-700 dark:text-gray-300 text-lg leading-relaxed">{{ question.text }}</p>
                    
                    {% if question.year or question.examtype %}
                    <div class="mt-3 flex gap-4 text-sm text-gray-500 dark:text-gray-400">
                        {% if question.year %}
                        <span>Year: {{ question.year }}</span>
                        {% endif %}
                        {% if question.examtype %}
                        <span>Exam: {{ question.examtype }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="space-y-3">
                    {% for option in question.options %}
                    <label class="flex items-center p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                        <input type="radio" 
                               name="question_{{ question.id }}" 
                               value="{{ option.option }}" 
                               class="mr-4 text-blue-600 focus:ring-blue-500"
                               data-question="{{ loop.index }}">
                        <span class="text-gray-700 dark:text-gray-300 text-base">{{ option.option }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Navigation buttons -->
        <div class="mt-8 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between">
                <button type="button" 
                        id="prev-btn" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    ‚Üê Previous
                </button>
                
                <div class="text-center">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <span id="answered-count">0</span> of {{ questions|length }} answered
                    </div>
                </div>
                
                <button type="button" 
                        id="next-btn" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    Next ‚Üí
                </button>
            </div>
            
            <!-- Submit button (hidden until last question) -->
            <div class="mt-4 text-center">
                <button type="submit" 
                        id="submit-btn"
                        class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition-colors"
                        style="display: none;">
                    Submit Exam
                </button>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const timerElement = document.getElementById('timer');
    const form = document.getElementById('exam-form');
    // Track whether the form has been submitted to prevent beforeunload prompts
    let formSubmitted = false;
    
    // Question navigation variables
    let currentQuestion = 1;
    const totalQuestions = {{ questions|length }};
    const questionSlides = document.querySelectorAll('.question-slide');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const currentQuestionSpan = document.getElementById('current-question');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const answeredCount = document.getElementById('answered-count');
    
    // Track answered questions
    const answeredQuestions = new Set();
    
    // Update progress and navigation
    function updateProgress() {
        const progress = (currentQuestion / totalQuestions) * 100;
        progressBar.style.width = progress + '%';
        progressPercentage.textContent = Math.round(progress) + '%';
        currentQuestionSpan.textContent = currentQuestion;
        answeredCount.textContent = answeredQuestions.size;
        
        // Update navigation buttons
        prevBtn.disabled = currentQuestion === 1;
        
        if (currentQuestion === totalQuestions) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'inline-block';
        } else {
            nextBtn.style.display = 'inline-block';
            submitBtn.style.display = 'none';
        }
    }
    
    // Show specific question
    function showQuestion(questionNum) {
        questionSlides.forEach((slide, index) => {
            slide.style.display = index + 1 === questionNum ? 'block' : 'none';
        });
        currentQuestion = questionNum;
        updateProgress();
    }
    
    // Check if current question is answered
    function checkCurrentQuestionAnswered() {
        const currentSlide = document.querySelector(`[data-question="${currentQuestion}"]`);
        const radioInputs = currentSlide.querySelectorAll('input[type="radio"]');
        const isAnswered = Array.from(radioInputs).some(input => input.checked);
        
        if (isAnswered) {
            answeredQuestions.add(currentQuestion);
        } else {
            answeredQuestions.delete(currentQuestion);
        }
        updateProgress();
    }
    
    // Event listeners for navigation
    prevBtn.addEventListener('click', function() {
        if (currentQuestion > 1) {
            showQuestion(currentQuestion - 1);
        }
    });
    
    nextBtn.addEventListener('click', function() {
        if (currentQuestion < totalQuestions) {
            showQuestion(currentQuestion + 1);
        }
    });
    
    // Event listeners for radio buttons
    document.querySelectorAll('input[type="radio"]').forEach(input => {
        input.addEventListener('change', checkCurrentQuestionAnswered);
    });
    
    // Initialize
    updateProgress();
    let timeRemaining = {{ subject.duration_minutes * 60 }}; // Convert to seconds
    
    function updateTimer() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeRemaining <= 0) {
            // Auto-submit when time runs out
            alert('Time is up! Your exam will be submitted automatically.');
            form.submit();
            return;
        }
        
        timeRemaining--;
    }
    
    // Update timer every second
    const timerInterval = setInterval(updateTimer, 1000);
    
    // Handle form submission (single consolidated handler)
    form.addEventListener('submit', function(e) {
        const checkedCount = form.querySelectorAll('input[type="radio"]:checked').length;
        const totalQuestions = {{ questions|length }};

        console.log(`DEBUG: Form submission - Answered: ${checkedCount}, Total: ${totalQuestions}`);

        if (checkedCount < totalQuestions) {
            e.preventDefault();
            const unanswered = totalQuestions - checkedCount;
            if (!confirm(`You have ${unanswered} unanswered question(s). Are you sure you want to submit?`)) {
                return;
            }
        }

        // Mark submitted, stop timer and remove beforeunload handler
        formSubmitted = true;
        clearInterval(timerInterval);
        try {
            window.removeEventListener('beforeunload', handleBeforeUnload);
        } catch (err) {
            // ignore
        }

        // Debug: Log all form data (keys/values)
        const formData = new FormData(form);
        console.log('DEBUG: Form data being submitted:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }

        console.log('DEBUG: Form submission proceeding...');
    });
    
    // Prevent page refresh/close during exam
    function handleBeforeUnload(e) {
        if (!formSubmitted) {
            e.preventDefault();
            e.returnValue = 'Are you sure you want to leave? Your progress will be lost.';
            return e.returnValue;
        }
    }

    window.addEventListener('beforeunload', handleBeforeUnload);
});
</script>
{% endblock %}
